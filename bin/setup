# Configure docker .env
DJANGO_PORT=8008
POSTGRES_PORT=5435
REDIS_PORT=6377
if [ $# -ge 1 ]; then
  DJANGO_PORT=$1
fi
if [ $# -ge 2 ]; then
  DB_PORT=$2
fi
if [ $# -ge 3 ]; then
  REDIS_PORT=$3
fi
sudo rm .env
touch .env
echo "# DOCKER PORTS" >> ".env"
echo "== MODIFY WITH WITH $ bin/setup <DJANGO_PORT> <POSTGRES_PORT> <REDIS_PORT> ==" >> ".env"
echo "" >> ".env"
echo "DJANGO_PORT=${DJANGO_PORT}" >> ".env"
echo "POSTGRES_PORT=${POSTGRES_PORT}" >> ".env"
echo "REDIS_PORT=${REDIS_PORT}" >> ".env"

# Delete previous containers
docker-compose -f bin/docker/docker-compose.dev.yml down

# Build project
docker-compose -f bin/docker/docker-compose.dev.yml build

# Set execute permissions to bin
docker-compose -f bin/docker/docker-compose.dev.yml run django chmod +x bin/*;chmod +x bin/docker/* 

# Creating .env.devs
docker-compose -f bin/docker/docker-compose.dev.yml run django bin/docker/env-dev.sh $DJANGO_PORT $POSTGRES_PORT $REDIS_PORT

# Execute entrypoint.sh (make & run migrations)
docker-compose -f bin/docker/docker-compose.dev.yml run django bin/docker/entrypoint.sh

# Generate docs
docker-compose -f bin/docker/docker-compose.dev.yml run django sphinx-build -E -b html ./docs ./.data/docs