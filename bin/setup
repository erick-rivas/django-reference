# Configure docker .env
DJANGO_PORT=8008
POSTGRES_PORT=5435
REDIS_PORT=6377
if [ $# -ge 1 ]; then
  DJANGO_PORT=$1
fi
if [ $# -ge 2 ]; then
  DB_PORT=$2
fi
if [ $# -ge 3 ]; then
  REDIS_PORT=$3
fi
sudo rm bin/docker/.env
echo "# DOCKER PORTS" >> "bin/docker/.env"
echo "### MODIFY WITH WITH $ bin/setup <DJANGO_PORT> <POSTGRES_PORT> <REDIS_PORT> ###" >> "bin/docker/.env"
echo "" >> "bin/docker/.env"
echo "DJANGO_PORT=${DJANGO_PORT}" >> "bin/docker/.env"
echo "POSTGRES_PORT=${POSTGRES_PORT}" >> "bin/docker/.env"
echo "REDIS_PORT=${REDIS_PORT}" >> "bin/docker/.env"

# Delete previous containers
docker-compose -f bin/docker/docker-compose.dev.yml down

# Build project
docker-compose -f bin/docker/docker-compose.dev.yml build

# Set execute permissions to bin
docker-compose -f bin/docker/docker-compose.dev.yml run django chmod +x bin/*;chmod +x bin/docker/* 

# Creating .env.devs
docker-compose -f bin/docker/docker-compose.dev.yml run django bin/docker/env-dev.sh $DJANGO_PORT $POSTGRES_PORT $REDIS_PORT

# Execute entrypoint.sh (make & run migrations)
docker-compose -f bin/docker/docker-compose.dev.yml run django bin/docker/entrypoint.sh

# Load dev fixtures (admin)
docker-compose -f bin/docker/docker-compose.dev.yml run django python manage.py loaddata bin/docker/fixtures-dev.yaml

# Generate docs
docker-compose -f bin/docker/docker-compose.dev.yml run django sphinx-build -E -b html ./docs ./.data/docs